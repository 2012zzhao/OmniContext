const u="sessions";class h{async saveSession(e){const n=await this.getAllSessions(),t=n.findIndex(s=>s.id===e.id);t>=0?n[t]={...e,updatedAt:Date.now()}:n.push(e),await chrome.storage.local.set({[u]:n})}async getSession(e){return(await this.getAllSessions()).find(t=>t.id===e)||null}async getAllSessions(){return(await chrome.storage.local.get(u))[u]||[]}async getSessionsByPlatform(e){return(await this.getAllSessions()).filter(t=>t.platform===e)}async deleteSession(e){const t=(await this.getAllSessions()).filter(s=>s.id!==e);await chrome.storage.local.set({[u]:t})}async updateSessionTitle(e,n){const t=await this.getSession(e);t&&(t.title=n,t.updatedAt=Date.now(),await this.saveSession(t))}async exportAllSessions(){const e=await this.getAllSessions();return JSON.stringify(e,null,2)}}const S=new h,g={doubao:{hostname:"doubao.com",titleSelectors:['[class*="chat-title"]','[class*="header-title"]','h1[class*="title"]','[data-testid="chat-title"]','[class*="conversation-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-list"], [class*="chat-container"], [class*="conversation-content"], [class*="message-container"]',user:'[class*="message-block-container"] [class*="bg-s-color-bg-trans"], [class*="user-message"], [data-role="user"]',assistant:'[class*="message-block-container"]:not(:has([class*="bg-s-color-bg-trans"])), [class*="bot-message"], [class*="ai-message"], [data-role="assistant"]'}},yuanbao:{hostname:"yuanbao.tencent.com",titleSelectors:[".session-title",".chat-title",".active .title",'[data-testid="session-title"]'],messageSelectors:{container:".message-container, .chat-content, .conversation-list",user:'.user-msg, .message.user, [data-role="user"]',assistant:'.assistant-msg, .message.assistant, .bot-reply, [data-role="assistant"]'}},claude:{hostname:"claude.ai",titleSelectors:[".conversation-title",'[aria-selected="true"] .title',".chat-title"],messageSelectors:{container:".conversation-content, .messages-container",user:'.human-message, .message.human, [data-testid="human-message"]',assistant:'.assistant-message, .message.assistant, [data-testid="assistant-message"]'}}};function x(l){const e=new URL(l).hostname;return e.includes("doubao.com")?"doubao":e.includes("yuanbao.tencent.com")?"yuanbao":e.includes("claude.ai")?"claude":null}function y(l,e){const t=new URL(l).pathname.split("/").filter(s=>s.length>0);for(const s of t)if(s&&s!=="chat"&&s!=="c"&&s.length>=4)return s;return`new-${Date.now()}`}function p(l){return{doubao:"豆包",yuanbao:"元宝",claude:"Claude"}[l]}class d{constructor(e){this.platform=e}get config(){return g[this.platform]}extractTitle(){for(const n of this.config.titleSelectors){const t=document.querySelector(n);if(t?.textContent?.trim())return t.textContent.trim()}const e=document.querySelector(this.config.messageSelectors.user);if(e?.textContent?.trim()){const n=e.textContent.trim();return n.slice(0,20)+(n.length>20?"...":"")}return`未命名对话 - ${new Date().toLocaleDateString()}`}extractMessages(){if(this.platform==="doubao")return this.extractDoubaoMessages();const e=[],n=document.querySelector(this.config.messageSelectors.container);return n?(n.querySelectorAll(`${this.config.messageSelectors.user}, ${this.config.messageSelectors.assistant}`).forEach((s,o)=>{const a=s.matches(this.config.messageSelectors.user),c=this.extractTextContent(s);c&&e.push({id:`${this.platform}-msg-${o}`,role:a?"user":"assistant",content:c,timestamp:Date.now()})}),e):this.extractMessagesFromDocument()}extractDoubaoMessages(){const e=[];return document.querySelectorAll('[class*="message-block-container"]').forEach((t,s)=>{if(t.querySelector('[class*="bg-s-color-bg-trans"]')){const a=t.querySelector('[class*="container-"]');if(a){const c=this.extractTextContent(a);c&&c.length>0&&e.push({id:`doubao-msg-${s}`,role:"user",content:c,timestamp:Date.now()})}}else{const a=t.querySelector('[class*="answer-content"], [class*="final-answer"], [class*="message-content"]:last-child');if(a){const r=this.extractTextContent(a);if(r&&r.length>0&&!r.includes("思考中")){e.push({id:`doubao-msg-${s}`,role:"assistant",content:r,timestamp:Date.now()});return}}const c=t.querySelector('[class*="container-"]');if(c){const r=this.extractDoubaoAssistantContent(c);r&&r.length>0&&e.push({id:`doubao-msg-${s}`,role:"assistant",content:r,timestamp:Date.now()})}}}),e}extractDoubaoAssistantContent(e){const n=e.textContent||"",t=[/思考中[\.。]+/,/ thinking[\.。]+/i],s=["</think>","正式回答：","回答：","最终答案："];for(const r of s){const i=n.split(r);if(i.length>1)return i[i.length-1].trim()}const o=Array.from(e.children);let a=!1,c="";for(const r of o){const i=r.textContent||"";if(t.some(f=>f.test(i))){a=!0;continue}const m=r.className||"";if(m.includes("thinking")||m.includes("thought")){a=!0;continue}a&&i.length>0&&(c+=i+`
`)}return c.length>0?c.trim():this.extractTextContent(e)}extractMessagesFromDocument(){const e=[],n=document.querySelectorAll(this.config.messageSelectors.user),t=document.querySelectorAll(this.config.messageSelectors.assistant),s=[...Array.from(n).map(o=>({el:o,isUser:!0})),...Array.from(t).map(o=>({el:o,isUser:!1}))];return s.sort((o,a)=>o.el.compareDocumentPosition(a.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),s.forEach(({el:o,isUser:a},c)=>{const r=this.extractTextContent(o);r&&e.push({id:`${this.platform}-msg-${c}`,role:a?"user":"assistant",content:r,timestamp:Date.now()})}),e}extractTextContent(e){const n=[".text-content",".message-content",".content","p",".text"];for(const t of n){const s=e.querySelector(t);if(s?.textContent?.trim())return s.textContent.trim()}return e.textContent?.trim()||""}}function b(l){return new d(l)}function C(l){try{console.log(`[OmniContext] Debugging ${l}...`);const e=g[l];if(!e){console.log("No config found for platform:",l);return}console.log("=== Title Selectors ===");for(const t of e.titleSelectors)try{const s=document.querySelector(t);console.log(`${t}: ${s?"✓":"✗"} ${s?.textContent?.slice(0,50)||""}`)}catch{console.log(`${t}: 选择器错误`)}console.log("=== Message Container ===");const n=document.querySelector(e.messageSelectors.container);console.log(`Container found: ${n?"✓":"✗"}`),console.log("=== User Messages ===");try{const t=document.querySelectorAll(e.messageSelectors.user);console.log(`Found ${t.length} user messages`),t.forEach((s,o)=>{o<3&&console.log(`  [${o}] ${s.className?.slice(0,50)}: ${s.textContent?.slice(0,50)}`)})}catch(t){console.log("User messages check failed:",t)}console.log("=== Assistant Messages ===");try{const t=document.querySelectorAll(e.messageSelectors.assistant);console.log(`Found ${t.length} assistant messages`),t.forEach((s,o)=>{o<3&&console.log(`  [${o}] ${s.className?.slice(0,50)}: ${s.textContent?.slice(0,50)}`)})}catch(t){console.log("Assistant messages check failed:",t)}console.log("=== Auto-detect Attempt ===");try{const t=document.querySelectorAll("div"),s=Array.from(t).filter(o=>{const a=o.textContent||"";return a.length>20&&a.length<500&&(o.className?.toLowerCase().includes("message")||o.className?.toLowerCase().includes("chat")||o.className?.toLowerCase().includes("bubble"))}).slice(0,5);console.log("Possible message elements:"),s.forEach((o,a)=>{console.log(`  [${a}] class="${o.className}" text="${o.textContent?.slice(0,80)}"`)})}catch(t){console.log("Auto-detect failed:",t)}console.log("=== End Debug ===")}catch(e){console.error("[OmniContext] Debug function error:",e)}}export{C as a,b as c,x as d,y as e,p as f,S as s};
