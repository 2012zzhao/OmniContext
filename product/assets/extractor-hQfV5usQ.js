const u="sessions";class h{async saveSession(e){const n=await this.getAllSessions(),s=n.findIndex(t=>t.id===e.id);s>=0?n[s]={...e,updatedAt:Date.now()}:n.push(e),await chrome.storage.local.set({[u]:n})}async getSession(e){return(await this.getAllSessions()).find(s=>s.id===e)||null}async getAllSessions(){return(await chrome.storage.local.get(u))[u]||[]}async getSessionsByPlatform(e){return(await this.getAllSessions()).filter(s=>s.platform===e)}async deleteSession(e){const s=(await this.getAllSessions()).filter(t=>t.id!==e);await chrome.storage.local.set({[u]:s})}async updateSessionTitle(e,n){const s=await this.getSession(e);s&&(s.title=n,s.updatedAt=Date.now(),await this.saveSession(s))}async exportAllSessions(){const e=await this.getAllSessions();return JSON.stringify(e,null,2)}}const S=new h,g={doubao:{hostname:"doubao.com",titleSelectors:['[class*="chat-title"]','[class*="header-title"]','h1[class*="title"]','[data-testid="chat-title"]','[class*="conversation-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-list"], [class*="chat-container"], [class*="conversation-content"], [class*="message-container"]',user:'[class*="message-block-container"] [class*="bg-s-color-bg-trans"], [class*="user-message"], [data-role="user"]',assistant:'[class*="message-block-container"]:not(:has([class*="bg-s-color-bg-trans"])), [class*="bot-message"], [class*="ai-message"], [data-role="assistant"]'}},yuanbao:{hostname:"yuanbao.tencent.com",titleSelectors:[".session-title",".chat-title",".active .title",'[data-testid="session-title"]','[class*="chat-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-container"], [class*="chat-content"], [class*="conversation-list"], [class*="message-list"], [class*="chat-list"]',user:'[class*="user-message"], [class*="user-msg"], [data-role="user"], [class*="message-user"]',assistant:'[class*="assistant-message"], [class*="assistant-msg"], [class*="bot-message"], [data-role="assistant"], [class*="message-assistant"]'}},claude:{hostname:"claude.ai",titleSelectors:[".conversation-title",'[aria-selected="true"] .title',".chat-title"],messageSelectors:{container:".conversation-content, .messages-container",user:'.human-message, .message.human, [data-testid="human-message"]',assistant:'.assistant-message, .message.assistant, [data-testid="assistant-message"]'}}};function x(r){const e=new URL(r).hostname;return e.includes("doubao.com")?"doubao":e.includes("yuanbao.tencent.com")?"yuanbao":e.includes("claude.ai")?"claude":null}function y(r,e){const s=new URL(r).pathname.split("/").filter(t=>t.length>0);for(const t of s)if(t&&t!=="chat"&&t!=="c"&&t.length>=4)return t;return`new-${Date.now()}`}function p(r){return{doubao:"豆包",yuanbao:"元宝",claude:"Claude"}[r]}class d{constructor(e){this.platform=e}get config(){return g[this.platform]}extractTitle(){for(const n of this.config.titleSelectors){const s=document.querySelector(n);if(s?.textContent?.trim())return s.textContent.trim()}const e=document.querySelector(this.config.messageSelectors.user);if(e?.textContent?.trim()){const n=e.textContent.trim();return n.slice(0,20)+(n.length>20?"...":"")}return`未命名对话 - ${new Date().toLocaleDateString()}`}extractMessages(){if(this.platform==="doubao")return this.extractDoubaoMessages();const e=[],n=document.querySelector(this.config.messageSelectors.container);return n?(n.querySelectorAll(`${this.config.messageSelectors.user}, ${this.config.messageSelectors.assistant}`).forEach((t,o)=>{const a=t.matches(this.config.messageSelectors.user),c=this.extractTextContent(t);c&&e.push({id:`${this.platform}-msg-${o}`,role:a?"user":"assistant",content:c,timestamp:Date.now()})}),e):this.extractMessagesFromDocument()}extractDoubaoMessages(){const e=[];return document.querySelectorAll('[class*="message-block-container"]').forEach((s,t)=>{if(s.querySelector('[class*="bg-s-color-bg-trans"]')){const a=s.querySelector('[class*="container-"]');if(a){const c=this.extractTextContent(a);c&&c.length>0&&e.push({id:`doubao-msg-${t}`,role:"user",content:c,timestamp:Date.now()})}}else{const a=s.querySelector('[class*="answer-content"], [class*="final-answer"], [class*="message-content"]:last-child');if(a){const l=this.extractTextContent(a);if(l&&l.length>0&&!l.includes("思考中")){e.push({id:`doubao-msg-${t}`,role:"assistant",content:l,timestamp:Date.now()});return}}const c=s.querySelector('[class*="container-"]');if(c){const l=this.extractDoubaoAssistantContent(c);l&&l.length>0&&e.push({id:`doubao-msg-${t}`,role:"assistant",content:l,timestamp:Date.now()})}}}),e}extractDoubaoAssistantContent(e){const n=e.textContent||"",s=[/思考中[\.。]+/,/ thinking[\.。]+/i],t=["</think>","正式回答：","回答：","最终答案："];for(const l of t){const i=n.split(l);if(i.length>1)return i[i.length-1].trim()}const o=Array.from(e.children);let a=!1,c="";for(const l of o){const i=l.textContent||"";if(s.some(f=>f.test(i))){a=!0;continue}const m=l.className||"";if(m.includes("thinking")||m.includes("thought")){a=!0;continue}a&&i.length>0&&(c+=i+`
`)}return c.length>0?c.trim():this.extractTextContent(e)}extractMessagesFromDocument(){const e=[],n=document.querySelectorAll(this.config.messageSelectors.user),s=document.querySelectorAll(this.config.messageSelectors.assistant),t=[...Array.from(n).map(o=>({el:o,isUser:!0})),...Array.from(s).map(o=>({el:o,isUser:!1}))];return t.sort((o,a)=>o.el.compareDocumentPosition(a.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),t.forEach(({el:o,isUser:a},c)=>{const l=this.extractTextContent(o);l&&e.push({id:`${this.platform}-msg-${c}`,role:a?"user":"assistant",content:l,timestamp:Date.now()})}),e}extractTextContent(e){const n=[".text-content",".message-content",".content","p",".text"];for(const s of n){const t=e.querySelector(s);if(t?.textContent?.trim())return t.textContent.trim()}return e.textContent?.trim()||""}}function b(r){return new d(r)}function C(r){try{console.log(`[OmniContext] Debugging ${r}...`);const e=g[r];if(!e){console.log("No config found for platform:",r);return}console.log("=== Title Selectors ===");for(const s of e.titleSelectors)try{const t=document.querySelector(s);console.log(`${s}: ${t?"✓":"✗"} ${t?.textContent?.slice(0,50)||""}`)}catch{console.log(`${s}: 选择器错误`)}console.log("=== Message Container ===");const n=document.querySelector(e.messageSelectors.container);console.log(`Container found: ${n?"✓":"✗"}`),console.log("=== User Messages ===");try{const s=document.querySelectorAll(e.messageSelectors.user);console.log(`Found ${s.length} user messages`),s.forEach((t,o)=>{o<3&&console.log(`  [${o}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)})}catch(s){console.log("User messages check failed:",s)}console.log("=== Assistant Messages ===");try{const s=document.querySelectorAll(e.messageSelectors.assistant);console.log(`Found ${s.length} assistant messages`),s.forEach((t,o)=>{o<3&&console.log(`  [${o}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)})}catch(s){console.log("Assistant messages check failed:",s)}console.log("=== Auto-detect Attempt ===");try{const s=document.querySelectorAll("div"),t=Array.from(s).filter(o=>{const a=o.textContent||"";return a.length>20&&a.length<500&&(o.className?.toLowerCase().includes("message")||o.className?.toLowerCase().includes("chat")||o.className?.toLowerCase().includes("bubble"))}).slice(0,5);console.log("Possible message elements:"),t.forEach((o,a)=>{console.log(`  [${a}] class="${o.className}" text="${o.textContent?.slice(0,80)}"`)})}catch(s){console.log("Auto-detect failed:",s)}console.log("=== End Debug ===")}catch(e){console.error("[OmniContext] Debug function error:",e)}}export{C as a,b as c,x as d,y as e,p as f,S as s};
