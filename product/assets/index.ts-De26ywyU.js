import{d as p,e as v,a as m,c as x,s as f}from"./extractor-hQfV5usQ.js";function n(...e){console.log("[OmniContext]",...e)}let t=null,s=null,a=[],i=null,o=!0;function h(){try{return!!chrome.runtime.id}catch{return!1}}function l(){try{const e=window.location.href;if(t=p(e),!t){n("Platform not detected");return}s=v(e,t),n("Detected:",t,"Session:",s);try{m(t)}catch(r){n("Debug failed:",r)}S()}catch(e){console.error("[OmniContext] Init failed:",e)}}function S(){n("Starting capture..."),setTimeout(()=>{u()},2e3),i=window.setInterval(()=>{if(!h()){o&&(o=!1,n("Extension context invalidated. Stopping capture."),i&&(clearInterval(i),i=null));return}u()},3e3)}function u(){if(t)try{const r=x(t).extractMessages();n("Found messages:",r.length),r.length>0&&JSON.stringify(r)!==JSON.stringify(a)&&(n("New messages detected, saving..."),a=r,w())}catch(e){n("Capture error:",e)}}async function w(){if(!(!t||!s)){if(!h()){o&&(o=!1,n("Extension context invalidated. Stopping save."));return}try{const r=x(t).extractTitle();if(a.length===0)return;const c={id:s,platform:t,title:r||"未命名对话",sourceUrl:window.location.href,createdAt:Date.now(),updatedAt:Date.now(),messages:a,messageCount:a.length},d=await f.getSession(s);d&&(c.createdAt=d.createdAt),await f.saveSession(c),n("✓ Saved:",r,`(${a.length}条消息)`)}catch(e){e?.message?.includes("Extension context invalidated")?o&&(o=!1,n("Extension context invalidated. Please refresh the page.")):console.error("[OmniContext] Save failed:",e)}}}window.debugAIMemoryBridge=()=>{t?m(t):console.log("No platform detected")};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l();let g=location.href;setInterval(()=>{location.href!==g&&(g=location.href,t=null,s=null,a=[],l())},1e3);
