const m="sessions";class f{async saveSession(e){const o=await this.getAllSessions(),t=o.findIndex(s=>s.id===e.id);t>=0?o[t]={...e,updatedAt:Date.now()}:o.push(e),await chrome.storage.local.set({[m]:o})}async getSession(e){return(await this.getAllSessions()).find(t=>t.id===e)||null}async getAllSessions(){return(await chrome.storage.local.get(m))[m]||[]}async getSessionsByPlatform(e){return(await this.getAllSessions()).filter(t=>t.platform===e)}async deleteSession(e){const t=(await this.getAllSessions()).filter(s=>s.id!==e);await chrome.storage.local.set({[m]:t})}async updateSessionTitle(e,o){const t=await this.getSession(e);t&&(t.title=o,t.updatedAt=Date.now(),await this.saveSession(t))}async exportAllSessions(){const e=await this.getAllSessions();return JSON.stringify(e,null,2)}}const x=new f,g={doubao:{hostname:"doubao.com",titleSelectors:['[class*="chat-title"]','[class*="header-title"]','h1[class*="title"]','[data-testid="chat-title"]','[class*="conversation-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-list"], [class*="chat-container"], [class*="conversation-content"], [class*="message-container"]',user:'[class*="message-block-container"] [class*="bg-s-color-bg-trans"], [class*="user-message"], [data-role="user"]',assistant:'[class*="message-block-container"]:not(:has([class*="bg-s-color-bg-trans"])), [class*="bot-message"], [class*="ai-message"], [data-role="assistant"]'}},yuanbao:{hostname:"yuanbao.tencent.com",titleSelectors:[".session-title",".chat-title",".active .title",'[data-testid="session-title"]','[class*="chat-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="agent-chat__list"], [class*="chat-list"], [class*="message-list"]',user:'[class*="bubble--human"], [class*="chat__bubble--human"]',assistant:'[class*="bubble--ai"], [class*="chat__bubble--ai"]'}},claude:{hostname:"claude.ai",titleSelectors:[".conversation-title",'[aria-selected="true"] .title',".chat-title",'[class*="conversation-title"]','[class*="chat-title"]',"h1","title"],messageSelectors:{container:'.conversation-content, .messages-container, [class*="conversation"], [class*="messages"]',user:'.human-message, .message.human, [data-testid="human-message"], [class*="human"], [class*="user-message"]',assistant:'.assistant-message, .message.assistant, [data-testid="assistant-message"], [class*="assistant"], [class*="claude-message"]'}}};function S(l){const e=new URL(l).hostname;return e.includes("doubao.com")?"doubao":e.includes("yuanbao.tencent.com")?"yuanbao":e.includes("claude.ai")?"claude":null}function C(l,e){const t=new URL(l).pathname.split("/").filter(s=>s.length>0);for(const s of t)if(s&&s!=="chat"&&s!=="c"&&s.length>=4)return s;return`new-${Date.now()}`}function b(l){return{doubao:"豆包",yuanbao:"元宝",claude:"Claude"}[l]}class d{constructor(e){this.platform=e}get config(){return g[this.platform]}extractTitle(){for(const o of this.config.titleSelectors){const t=document.querySelector(o);if(t?.textContent?.trim())return t.textContent.trim()}const e=document.querySelector(this.config.messageSelectors.user);if(e?.textContent?.trim()){const o=e.textContent.trim();return o.slice(0,20)+(o.length>20?"...":"")}return`未命名对话 - ${new Date().toLocaleDateString()}`}extractMessages(){if(this.platform==="doubao")return this.extractDoubaoMessages();if(this.platform==="yuanbao")return this.extractYuanbaoMessages();if(this.platform==="claude")return this.extractClaudeMessages();const e=[],o=document.querySelector(this.config.messageSelectors.container);return o?(o.querySelectorAll(`${this.config.messageSelectors.user}, ${this.config.messageSelectors.assistant}`).forEach((s,n)=>{const a=s.matches(this.config.messageSelectors.user),c=this.extractTextContent(s);c&&e.push({id:`${this.platform}-msg-${n}`,role:a?"user":"assistant",content:c,timestamp:Date.now()})}),e):this.extractMessagesFromDocument()}extractDoubaoMessages(){const e=[];return document.querySelectorAll('[class*="message-block-container"]').forEach((t,s)=>{if(t.querySelector('[class*="bg-s-color-bg-trans"]')){const a=t.querySelector('[class*="container-"]');if(a){const c=this.extractTextContent(a);c&&c.length>0&&e.push({id:`doubao-msg-${s}`,role:"user",content:c,timestamp:Date.now()})}}else{const a=t.querySelector('[class*="answer-content"], [class*="final-answer"], [class*="message-content"]:last-child');if(a){const r=this.extractTextContent(a);if(r&&r.length>0&&!r.includes("思考中")){e.push({id:`doubao-msg-${s}`,role:"assistant",content:r,timestamp:Date.now()});return}}const c=t.querySelector('[class*="container-"]');if(c){const r=this.extractDoubaoAssistantContent(c);r&&r.length>0&&e.push({id:`doubao-msg-${s}`,role:"assistant",content:r,timestamp:Date.now()})}}}),e}extractDoubaoAssistantContent(e){const o=e.textContent||"",t=[/思考中[\.。]+/,/ thinking[\.。]+/i],s=["</think>","正式回答：","回答：","最终答案："];for(const r of s){const i=o.split(r);if(i.length>1)return i[i.length-1].trim()}const n=Array.from(e.children);let a=!1,c="";for(const r of n){const i=r.textContent||"";if(t.some(h=>h.test(i))){a=!0;continue}const u=r.className||"";if(u.includes("thinking")||u.includes("thought")){a=!0;continue}a&&i.length>0&&(c+=i+`
`)}return c.length>0?c.trim():this.extractTextContent(e)}extractYuanbaoMessages(){const e=[],o=['[class*="agent-chat__list"]','[class*="chat-list"]','[class*="message-list"]'];let t=null;for(const c of o)if(t=document.querySelector(c),t)break;const s=document.querySelectorAll('[class*="bubble--human"]'),n=document.querySelectorAll('[class*="bubble--ai"]');if(s.length===0&&n.length===0)return this.extractYuanbaoFromDocument();const a=[...Array.from(s).map(c=>({el:c,isUser:!0})),...Array.from(n).map(c=>({el:c,isUser:!1}))];return a.sort((c,r)=>c.el.compareDocumentPosition(r.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),a.forEach(({el:c,isUser:r},i)=>{const u=r?this.extractYuanbaoUserContent(c):this.extractYuanbaoAssistantContent(c);u&&e.push({id:`yuanbao-msg-${i}`,role:r?"user":"assistant",content:u,timestamp:Date.now()})}),e}extractYuanbaoFromDocument(){const e=[],o=['[class*="bubble--human"]','[class*="chat__bubble--human"]'],t=['[class*="bubble--ai"]','[class*="chat__bubble--ai"]'],s=[];for(const n of o)document.querySelectorAll(n).forEach(a=>{s.push({el:a,isUser:!0})});for(const n of t)document.querySelectorAll(n).forEach(a=>{s.push({el:a,isUser:!1})});return s.sort((n,a)=>n.el.compareDocumentPosition(a.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),s.forEach(({el:n,isUser:a},c)=>{const r=a?this.extractYuanbaoUserContent(n):this.extractYuanbaoAssistantContent(n);r&&e.push({id:`yuanbao-msg-${c}`,role:a?"user":"assistant",content:r,timestamp:Date.now()})}),e}extractYuanbaoUserContent(e){const o=['[class*="content"]','[class*="text"]','[class*="message-body"]',".content","p"];for(const t of o){const s=e.querySelector(t);if(s?.textContent?.trim())return s.textContent.trim()}return e.textContent?.trim()||""}extractYuanbaoAssistantContent(e){const o=['[class*="answer"]','[class*="final"]','[class*="response"]','[class*="result"]','[class*="output"]'];for(const c of o){const r=e.querySelector(c);if(r?.textContent?.trim()){const i=r.textContent.trim();if(!this.isYuanbaoThinkingContent(i))return i}}const t=e.textContent||"",s=["思考过程","思考中","正在思考","Think","Thinking"];for(const c of s)if(t.includes(c)){const r=t.split(new RegExp(`${c}[\\s\\S]*?(?=[
\r]{2}|$)`,"i"));if(r.length>1&&r[r.length-1].trim())return r[r.length-1].trim()}const n=Array.from(e.children);let a="";for(const c of n){const r=(c.className||"").toLowerCase();if(r.includes("thinking")||r.includes("thought")||r.includes("reasoning")||r.includes("process"))continue;const i=c.textContent?.trim()||"";i&&!this.isYuanbaoThinkingContent(i)&&(a+=i+`
`)}return a.trim()?a.trim():this.cleanYuanbaoContent(t)}isYuanbaoThinkingContent(e){return[/^思考[过程中]/,/^Think(ing)?[:：]/i,/^正在分析/,/^推理过程/].some(t=>t.test(e.trim()))}cleanYuanbaoContent(e){const o=[/【思考】[\s\S]*?【回答】/,/<thinking>[\s\S]*?<\/thinking>/gi,/思考过程：[\s\S]*?(?=\n\n|回答)/];let t=e;for(const s of o)t=t.replace(s,"");return t.trim()}extractClaudeMessages(){const e=[],o=['[class*="conversation"]','[class*="messages"]','[data-testid="conversation"]',".prose","main"];let t=null;for(const n of o)if(t=document.querySelector(n),t)break;if(!t)return this.extractClaudeFromDocument();const s=t.querySelectorAll('[class*="message"], [data-testid*="message"], [class*="turn"]');return s.length===0?this.extractClaudeFromDocument():(s.forEach((n,a)=>{const c=n.className||"",r=n.getAttribute("data-testid")||"";if(/human|user/i.test(c+r)||n.querySelector('[class*="human"], [class*="user"]')){const u=this.extractClaudeUserContent(n);u&&e.push({id:`claude-msg-${a}`,role:"user",content:u,timestamp:Date.now()})}else{const u=this.extractClaudeAssistantContent(n);u&&e.push({id:`claude-msg-${a}`,role:"assistant",content:u,timestamp:Date.now()})}}),e)}extractClaudeFromDocument(){const e=[],o=[];return document.querySelectorAll('[class*="human"], [class*="user-message"]').forEach(t=>{o.push({el:t,isUser:!0})}),document.querySelectorAll('[class*="assistant"], [class*="claude-message"]').forEach(t=>{o.push({el:t,isUser:!1})}),o.sort((t,s)=>t.el.compareDocumentPosition(s.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),o.forEach(({el:t,isUser:s},n)=>{const a=s?this.extractClaudeUserContent(t):this.extractClaudeAssistantContent(t);a&&e.push({id:`claude-msg-${n}`,role:s?"user":"assistant",content:a,timestamp:Date.now()})}),e}extractClaudeUserContent(e){const o=['[class*="content"]','[class*="text"]',".prose","p"];for(const t of o){const s=e.querySelector(t);if(s?.textContent?.trim())return s.textContent.trim()}return e.textContent?.trim()||""}extractClaudeAssistantContent(e){const o=['[class*="response"]','[class*="answer"]','[class*="content"]:not([class*="thinking"])',".prose"];for(const s of o){const n=e.querySelector(s);if(n?.textContent?.trim()){const a=n.textContent.trim();if(!this.isClaudeThinkingContent(a))return a}}if(e.querySelector('[class*="thinking"], [class*="thought"], [data-thinking]')){const s=e.cloneNode(!0),n=s.querySelector('[class*="thinking"], [class*="thought"], [data-thinking]');n&&n.remove();const a=s.textContent?.trim();if(a&&a.length>10)return a}return this.cleanClaudeContent(e.textContent||"")}isClaudeThinkingContent(e){return[/^Thinking[:：]/i,/^Extended thinking/i,/^Let me think/i,/^I need to think/i].some(t=>t.test(e.trim().slice(0,50)))}cleanClaudeContent(e){const o=[/\[Thinking\][\s\S]*?\[\/Thinking\]/gi,/<thinking>[\s\S]*?<\/thinking>/gi,/Thinking:\n[\s\S]*?(?=\n\n|Response|Answer)/i];let t=e;for(const s of o)t=t.replace(s,"");return t.trim()}extractMessagesFromDocument(){const e=[],o=document.querySelectorAll(this.config.messageSelectors.user),t=document.querySelectorAll(this.config.messageSelectors.assistant),s=[...Array.from(o).map(n=>({el:n,isUser:!0})),...Array.from(t).map(n=>({el:n,isUser:!1}))];return s.sort((n,a)=>n.el.compareDocumentPosition(a.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),s.forEach(({el:n,isUser:a},c)=>{const r=this.extractTextContent(n);r&&e.push({id:`${this.platform}-msg-${c}`,role:a?"user":"assistant",content:r,timestamp:Date.now()})}),e}extractTextContent(e){const o=[".text-content",".message-content",".content","p",".text"];for(const t of o){const s=e.querySelector(t);if(s?.textContent?.trim())return s.textContent.trim()}return e.textContent?.trim()||""}}function p(l){return new d(l)}function y(l){try{console.log(`[OmniContext] Debugging ${l}...`);const e=g[l];if(!e){console.log("No config found for platform:",l);return}console.log("=== Title Selectors ===");for(const t of e.titleSelectors)try{const s=document.querySelector(t);console.log(`${t}: ${s?"✓":"✗"} ${s?.textContent?.slice(0,50)||""}`)}catch{console.log(`${t}: 选择器错误`)}console.log("=== Message Container ===");const o=document.querySelector(e.messageSelectors.container);console.log(`Container found: ${o?"✓":"✗"}`),console.log("=== User Messages ===");try{const t=document.querySelectorAll(e.messageSelectors.user);console.log(`Found ${t.length} user messages`),t.forEach((s,n)=>{n<3&&console.log(`  [${n}] ${s.className?.slice(0,50)}: ${s.textContent?.slice(0,50)}`)})}catch(t){console.log("User messages check failed:",t)}console.log("=== Assistant Messages ===");try{const t=document.querySelectorAll(e.messageSelectors.assistant);console.log(`Found ${t.length} assistant messages`),t.forEach((s,n)=>{n<3&&console.log(`  [${n}] ${s.className?.slice(0,50)}: ${s.textContent?.slice(0,50)}`)})}catch(t){console.log("Assistant messages check failed:",t)}console.log("=== Auto-detect Attempt ===");try{const t=document.querySelectorAll("div"),s=Array.from(t).filter(n=>{const a=n.textContent||"";return a.length>20&&a.length<500&&(n.className?.toLowerCase().includes("message")||n.className?.toLowerCase().includes("chat")||n.className?.toLowerCase().includes("bubble"))}).slice(0,5);console.log("Possible message elements:"),s.forEach((n,a)=>{console.log(`  [${a}] class="${n.className}" text="${n.textContent?.slice(0,80)}"`)})}catch(t){console.log("Auto-detect failed:",t)}console.log("=== End Debug ===")}catch(e){console.error("[OmniContext] Debug function error:",e)}}export{y as a,p as c,S as d,C as e,b as f,x as s};
