const l="sessions";class m{async saveSession(e){const o=await this.getAllSessions(),s=o.findIndex(t=>t.id===e.id);s>=0?o[s]={...e,updatedAt:Date.now()}:o.push(e),await chrome.storage.local.set({[l]:o})}async getSession(e){return(await this.getAllSessions()).find(s=>s.id===e)||null}async getAllSessions(){return(await chrome.storage.local.get(l))[l]||[]}async getSessionsByPlatform(e){return(await this.getAllSessions()).filter(s=>s.platform===e)}async deleteSession(e){const s=(await this.getAllSessions()).filter(t=>t.id!==e);await chrome.storage.local.set({[l]:s})}async updateSessionTitle(e,o){const s=await this.getSession(e);s&&(s.title=o,s.updatedAt=Date.now(),await this.saveSession(s))}async exportAllSessions(){const e=await this.getAllSessions();return JSON.stringify(e,null,2)}}const f=new m,u={doubao:{hostname:"doubao.com",titleSelectors:['[class*="chat-title"]','[class*="header-title"]','h1[class*="title"]','[data-testid="chat-title"]','[class*="conversation-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-list"], [class*="chat-container"], [class*="conversation-content"], [class*="message-container"]',user:'[class*="message-block-container"] [class*="bg-s-color-bg-trans"], [class*="user-message"], [data-role="user"]',assistant:'[class*="message-block-container"]:not(:has([class*="bg-s-color-bg-trans"])), [class*="bot-message"], [class*="ai-message"], [data-role="assistant"]'}},yuanbao:{hostname:"yuanbao.tencent.com",titleSelectors:[".session-title",".chat-title",".active .title",'[data-testid="session-title"]'],messageSelectors:{container:".message-container, .chat-content, .conversation-list",user:'.user-msg, .message.user, [data-role="user"]',assistant:'.assistant-msg, .message.assistant, .bot-reply, [data-role="assistant"]'}},claude:{hostname:"claude.ai",titleSelectors:[".conversation-title",'[aria-selected="true"] .title',".chat-title"],messageSelectors:{container:".conversation-content, .messages-container",user:'.human-message, .message.human, [data-testid="human-message"]',assistant:'.assistant-message, .message.assistant, [data-testid="assistant-message"]'}}};function d(a){const e=new URL(a).hostname;return e.includes("doubao.com")?"doubao":e.includes("yuanbao.tencent.com")?"yuanbao":e.includes("claude.ai")?"claude":null}function h(a,e){const s=new URL(a).pathname.split("/").filter(t=>t.length>0);for(const t of s)if(t&&t!=="chat"&&t!=="c"&&t.length>=4)return t;return`new-${Date.now()}`}function S(a){return{doubao:"豆包",yuanbao:"元宝",claude:"Claude"}[a]}class g{constructor(e){this.platform=e}get config(){return u[this.platform]}extractTitle(){for(const o of this.config.titleSelectors){const s=document.querySelector(o);if(s?.textContent?.trim())return s.textContent.trim()}const e=document.querySelector(this.config.messageSelectors.user);if(e?.textContent?.trim()){const o=e.textContent.trim();return o.slice(0,20)+(o.length>20?"...":"")}return`未命名对话 - ${new Date().toLocaleDateString()}`}extractMessages(){if(this.platform==="doubao")return this.extractDoubaoMessages();const e=[],o=document.querySelector(this.config.messageSelectors.container);return o?(o.querySelectorAll(`${this.config.messageSelectors.user}, ${this.config.messageSelectors.assistant}`).forEach((t,n)=>{const c=t.matches(this.config.messageSelectors.user),r=this.extractTextContent(t);r&&e.push({id:`${this.platform}-msg-${n}`,role:c?"user":"assistant",content:r,timestamp:Date.now()})}),e):this.extractMessagesFromDocument()}extractDoubaoMessages(){const e=[];return document.querySelectorAll('[class*="message-block-container"]').forEach((s,t)=>{const n=s.querySelector('[class*="bg-s-color-bg-trans"]'),c=s.querySelector('[class*="container-"]');if(c){const r=this.extractTextContent(c);r&&r.length>0&&e.push({id:`doubao-msg-${t}`,role:n?"user":"assistant",content:r,timestamp:Date.now()})}}),e}extractMessagesFromDocument(){const e=[],o=document.querySelectorAll(this.config.messageSelectors.user),s=document.querySelectorAll(this.config.messageSelectors.assistant),t=[...Array.from(o).map(n=>({el:n,isUser:!0})),...Array.from(s).map(n=>({el:n,isUser:!1}))];return t.sort((n,c)=>n.el.compareDocumentPosition(c.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),t.forEach(({el:n,isUser:c},r)=>{const i=this.extractTextContent(n);i&&e.push({id:`${this.platform}-msg-${r}`,role:c?"user":"assistant",content:i,timestamp:Date.now()})}),e}extractTextContent(e){const o=[".text-content",".message-content",".content","p",".text"];for(const s of o){const t=e.querySelector(s);if(t?.textContent?.trim())return t.textContent.trim()}return e.textContent?.trim()||""}}function x(a){return new g(a)}function y(a){try{console.log(`[OmniContext] Debugging ${a}...`);const e=u[a];if(!e){console.log("No config found for platform:",a);return}console.log("=== Title Selectors ===");for(const s of e.titleSelectors)try{const t=document.querySelector(s);console.log(`${s}: ${t?"✓":"✗"} ${t?.textContent?.slice(0,50)||""}`)}catch{console.log(`${s}: 选择器错误`)}console.log("=== Message Container ===");const o=document.querySelector(e.messageSelectors.container);console.log(`Container found: ${o?"✓":"✗"}`),console.log("=== User Messages ===");try{const s=document.querySelectorAll(e.messageSelectors.user);console.log(`Found ${s.length} user messages`),s.forEach((t,n)=>{n<3&&console.log(`  [${n}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)})}catch(s){console.log("User messages check failed:",s)}console.log("=== Assistant Messages ===");try{const s=document.querySelectorAll(e.messageSelectors.assistant);console.log(`Found ${s.length} assistant messages`),s.forEach((t,n)=>{n<3&&console.log(`  [${n}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)})}catch(s){console.log("Assistant messages check failed:",s)}console.log("=== Auto-detect Attempt ===");try{const s=document.querySelectorAll("div"),t=Array.from(s).filter(n=>{const c=n.textContent||"";return c.length>20&&c.length<500&&(n.className?.toLowerCase().includes("message")||n.className?.toLowerCase().includes("chat")||n.className?.toLowerCase().includes("bubble"))}).slice(0,5);console.log("Possible message elements:"),t.forEach((n,c)=>{console.log(`  [${c}] class="${n.className}" text="${n.textContent?.slice(0,80)}"`)})}catch(s){console.log("Auto-detect failed:",s)}console.log("=== End Debug ===")}catch(e){console.error("[OmniContext] Debug function error:",e)}}export{y as a,x as c,d,h as e,S as f,f as s};
