const i="sessions";class m{async saveSession(e){const o=await this.getAllSessions(),s=o.findIndex(n=>n.id===e.id);s>=0?o[s]={...e,updatedAt:Date.now()}:o.push(e),await chrome.storage.local.set({[i]:o})}async getSession(e){return(await this.getAllSessions()).find(s=>s.id===e)||null}async getAllSessions(){return(await chrome.storage.local.get(i))[i]||[]}async getSessionsByPlatform(e){return(await this.getAllSessions()).filter(s=>s.platform===e)}async deleteSession(e){const s=(await this.getAllSessions()).filter(n=>n.id!==e);await chrome.storage.local.set({[i]:s})}async updateSessionTitle(e,o){const s=await this.getSession(e);s&&(s.title=o,s.updatedAt=Date.now(),await this.saveSession(s))}async exportAllSessions(){const e=await this.getAllSessions();return JSON.stringify(e,null,2)}}const d=new m,u={doubao:{hostname:"doubao.com",titleSelectors:['[class*="chat-title"]','[class*="header-title"]','h1[class*="title"]','[data-testid="chat-title"]','[class*="conversation-title"]','[class*="session-title"]',"title"],messageSelectors:{container:'[class*="message-list"], [class*="chat-container"], [class*="conversation-content"], [class*="message-container"]',user:'[class*="message-block-container"] [class*="bg-s-color-bg-trans"], [class*="user-message"], [data-role="user"]',assistant:'[class*="message-block-container"]:not(:has([class*="bg-s-color-bg-trans"])), [class*="bot-message"], [class*="ai-message"], [data-role="assistant"]'}},yuanbao:{hostname:"yuanbao.tencent.com",titleSelectors:[".session-title",".chat-title",".active .title",'[data-testid="session-title"]'],messageSelectors:{container:".message-container, .chat-content, .conversation-list",user:'.user-msg, .message.user, [data-role="user"]',assistant:'.assistant-msg, .message.assistant, .bot-reply, [data-role="assistant"]'}},claude:{hostname:"claude.ai",titleSelectors:[".conversation-title",'[aria-selected="true"] .title',".chat-title"],messageSelectors:{container:".conversation-content, .messages-container",user:'.human-message, .message.human, [data-testid="human-message"]',assistant:'.assistant-message, .message.assistant, [data-testid="assistant-message"]'}}};function f(r){const e=new URL(r).hostname;return e.includes("doubao.com")?"doubao":e.includes("yuanbao.tencent.com")?"yuanbao":e.includes("claude.ai")?"claude":null}function h(r,e){const s=new URL(r).pathname.split("/").filter(n=>n.length>0);for(const n of s)if(n&&n!=="chat"&&n!=="c"&&n.length>=4)return n;return`new-${Date.now()}`}function S(r){return{doubao:"豆包",yuanbao:"元宝",claude:"Claude"}[r]}class g{constructor(e){this.platform=e}get config(){return u[this.platform]}extractTitle(){for(const o of this.config.titleSelectors){const s=document.querySelector(o);if(s?.textContent?.trim())return s.textContent.trim()}const e=document.querySelector(this.config.messageSelectors.user);if(e?.textContent?.trim()){const o=e.textContent.trim();return o.slice(0,20)+(o.length>20?"...":"")}return`未命名对话 - ${new Date().toLocaleDateString()}`}extractMessages(){if(this.platform==="doubao")return this.extractDoubaoMessages();const e=[],o=document.querySelector(this.config.messageSelectors.container);return o?(o.querySelectorAll(`${this.config.messageSelectors.user}, ${this.config.messageSelectors.assistant}`).forEach((n,c)=>{const l=n.matches(this.config.messageSelectors.user),t=this.extractTextContent(n);t&&e.push({id:`${this.platform}-msg-${c}`,role:l?"user":"assistant",content:t,timestamp:Date.now()})}),e):this.extractMessagesFromDocument()}extractDoubaoMessages(){const e=[];return document.querySelectorAll('[class*="message-block-container"]').forEach((s,n)=>{const c=s.querySelector('[class*="bg-s-color-bg-trans"]'),l=s.querySelector('[class*="container-"]');if(l){const t=this.extractTextContent(l);t&&t.length>0&&e.push({id:`doubao-msg-${n}`,role:c?"user":"assistant",content:t,timestamp:Date.now()})}}),e}extractMessagesFromDocument(){const e=[],o=document.querySelectorAll(this.config.messageSelectors.user),s=document.querySelectorAll(this.config.messageSelectors.assistant),n=[...Array.from(o).map(c=>({el:c,isUser:!0})),...Array.from(s).map(c=>({el:c,isUser:!1}))];return n.sort((c,l)=>c.el.compareDocumentPosition(l.el)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1),n.forEach(({el:c,isUser:l},t)=>{const a=this.extractTextContent(c);a&&e.push({id:`${this.platform}-msg-${t}`,role:l?"user":"assistant",content:a,timestamp:Date.now()})}),e}extractTextContent(e){const o=[".text-content",".message-content",".content","p",".text"];for(const s of o){const n=e.querySelector(s);if(n?.textContent?.trim())return n.textContent.trim()}return e.textContent?.trim()||""}}function x(r){return new g(r)}function y(r){console.log(`[OmniContext] Debugging ${r}...`);const e=u[r];console.log("=== Title Selectors ===");for(const t of e.titleSelectors){const a=document.querySelector(t);console.log(`${t}: ${a?"✓":"✗"} ${a?.textContent?.slice(0,50)||""}`)}console.log("=== Message Container ===");const o=document.querySelector(e.messageSelectors.container);console.log(`Container found: ${o?"✓":"✗"}`),console.log("=== User Messages ===");const s=document.querySelectorAll(e.messageSelectors.user);console.log(`Found ${s.length} user messages`),s.forEach((t,a)=>{a<3&&console.log(`  [${a}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)}),console.log("=== Assistant Messages ===");const n=document.querySelectorAll(e.messageSelectors.assistant);console.log(`Found ${n.length} assistant messages`),n.forEach((t,a)=>{a<3&&console.log(`  [${a}] ${t.className?.slice(0,50)}: ${t.textContent?.slice(0,50)}`)}),console.log("=== Auto-detect Attempt ===");const c=document.querySelectorAll("div"),l=Array.from(c).filter(t=>{const a=t.textContent||"";return a.length>20&&a.length<500&&(t.className?.toLowerCase().includes("message")||t.className?.toLowerCase().includes("chat")||t.className?.toLowerCase().includes("bubble"))}).slice(0,5);console.log("Possible message elements:"),l.forEach((t,a)=>{console.log(`  [${a}] class="${t.className}" text="${t.textContent?.slice(0,80)}"`)})}export{y as a,x as c,f as d,h as e,S as f,d as s};
